clear all

a_range = linspace(0, 2*pi, 100); 
b_range = linspace(0, 2*pi, 100); 

R = zeros(length(a_range), length(b_range));

progress_bar = waitbar(0, 'Calculating...');

s = 3;
n = 1;
p = 1;
r = 1;
d = sqrt(2*n*p);
L = sqrt((4*p+r^2)/3);

for i = 1:length(a_range)
    for j = 1:length(b_range)
        a = a_range(i);
        b = b_range(j);
        
        integrand = @(k, u, c) ((k.^2).*exp(-1.5*k.^2)).*((u.^2).*(1-u.^2).*exp(-(d.*u).^2).*(cos(s.*k.*u.*cos(b)/L))).*(((cos(c)).*(sin(c))).*(cos(k.*sqrt(1-u.^2).*(s.*sin(b).*cos(a).*cos(c)+s.*sin(a).*sin(b).*sin(c))/(L))));
        
        result = integral3(integrand, 0, Inf, -1, 1, 0, 2*pi);
        B = ((6*sqrt(6)*(d^3))/(erf(d)*(pi^2)))*(1-(3/(2*d^2))*(1-((2*d*exp(-d^2))/(erf(d)*sqrt(pi)))))^(-1);
        R(i, j) = result*B;
    end
     waitbar(i / length(a_range), progress_bar);
end
close(progress_bar);

[A, T] = meshgrid(a_range, b_range);
Rho = R;

X = Rho .* cos(T) .* sin(A);
Y = Rho .* sin(T) .* sin(A);
Z = Rho .* cos(A);

figure (2);
surf(X, Y, Z);
xlabel('X');
ylabel('Y');
zlabel('Z');
